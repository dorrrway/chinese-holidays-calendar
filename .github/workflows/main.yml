name: data-watch

on:
  schedule:
    - cron: "0 1 * * 1"   # 每周一 09:00 北京时间
  workflow_dispatch: {}   # 手动触发
  push:
    paths:
      - "data/*.txt"      # 你自己的 fork 有变更也会触发

permissions:
  contents: read
  issues: write

jobs:
  watch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Fetch upstream
        run: |
          git remote add upstream https://github.com/muhac/chinese-holidays-calendar.git
          git fetch upstream main

      - name: Diff data/*.txt
        id: diff
        run: |
          git diff --name-only origin/main..upstream/main -- data/*.txt > /tmp/changed.txt
          if [ -s /tmp/changed.txt ]; then
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            cat /tmp/changed.txt
          else
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes."
          fi

      - name: Open or update issue
        if: steps.diff.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const changed = fs.readFileSync('/tmp/changed.txt','utf8').trim().split('\n');
            const body = `检测到 upstream/main 数据变更:\n\n${changed.map(f=>`- ${f}`).join('\n')}\n\n运行: ${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            const {owner, repo} = context.repo;
            // 如有已有 data-watch issue，追加评论；否则新建
            const issues = await github.rest.issues.listForRepo({owner, repo, state:'open', labels:'data-watch'});
            if (issues.data.length > 0) {
              await github.rest.issues.createComment({owner, repo, issue_number: issues.data[0].number, body});
            } else {
              await github.rest.issues.create({owner, repo, title:'发现数据变更', body, labels:['data-watch']});
            }

      - name: No changes
        if: steps.diff.outputs.has_changes != 'true'
        run: echo "No upstream changes detected."
